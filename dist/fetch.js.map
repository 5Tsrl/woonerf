{"version":3,"sources":["fetch.js"],"names":["middleware","runFetch","runFetchAction","runFetchMultiple","fetch","require","INCREMENT_FETCH","DECREMENT_FETCH","FETCH","FETCH_MULTIPLE","FETCH_ERROR","incrementFetches","decrementFetches","fetchAction","fetchMultiple","fetchError","store","next","action","type","dispatch","payload","getState","state","options","retry","url","headers","createAuthorizationHeader","createContentHeader","body","filteredHeaders","filter","key","undefined","forEach","serialize","then","checkStatus","createResponse","response","dispatchFetchError","length","wrappedNext","wrapNext","catch","error","createErrorResponse","actions","push","fetches","map","all","responses","user","idToken","Authorization","res","status","window","FormData","resolve","deserialize","value","statusText","err","header","get","indexOf","json","arrayBuffer","text"],"mappings":"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","file":"fetch.js","sourcesContent":["// @flow\nimport isObject from 'lodash/isObject'\nimport createAction from 'redux-actions/lib/createAction'\nif (typeof (fetch) === 'undefined') {\n  require('isomorphic-fetch')\n}\n\nexport const INCREMENT_FETCH = 'increment outstanding fetches'\nexport const DECREMENT_FETCH = 'decrement outstanding fetches'\nexport const FETCH = 'fetch'\nexport const FETCH_MULTIPLE = 'fetch multiple'\nexport const FETCH_ERROR = 'fetch error'\n\nexport const incrementFetches = createAction(INCREMENT_FETCH)\nexport const decrementFetches = createAction(DECREMENT_FETCH)\nexport const fetchAction = createAction(FETCH)\nexport const fetchMultiple = createAction(FETCH_MULTIPLE)\nexport const fetchError = createAction(FETCH_ERROR)\n\nexport function middleware (store) {\n  return (next) => (action) => {\n    if (action.type === FETCH) {\n      return store.dispatch(runFetchAction(action.payload, store.getState()))\n    } else if (action.type === FETCH_MULTIPLE) {\n      return store.dispatch(runFetchMultiple(action.payload, store.getState()))\n    } else {\n      return next(action)\n    }\n  }\n}\n\nexport default fetchAction\n\n/**\n * Calls fetch, adds Auth and Content header if needed. Automatically parses content based on type.\n *\n * @returns Promise\n */\nexport function runFetch ({\n  options = {},\n  retry = false,\n  url\n}, state) {\n  const headers = {\n    ...createAuthorizationHeader(state),\n    ...createContentHeader(options.body),\n    ...(options.headers || {})\n  }\n\n  const filteredHeaders = {}\n\n  // allow removing generated headers by specifiying { header: null } in options.headers\n  // do this in two steps because otherwise we're modifying the object as we're iterating over it\n  Object.keys(headers)\n    .filter(key => headers[key] !== null && headers[key] !== undefined)\n    .forEach(key => { filteredHeaders[key] = headers[key] })\n\n  return fetch(url, {\n    ...options,\n    body: serialize(options.body),\n    headers: filteredHeaders\n  })\n    .then(checkStatus)\n    .then(createResponse)\n    .then(async (response) =>\n      (retry && await retry(response))\n        ? runFetch({options, retry, url}, state)\n        : response)\n}\n\nexport function runFetchAction ({\n  next,\n  options = {},\n  retry = false,\n  url\n}, state) {\n  const dispatchFetchError = !next || next.length < 2\n  const wrappedNext = wrapNext(next)\n\n  return [\n    incrementFetches({options, url}),\n    runFetch({options, retry, url}, state)\n      .then((response) => [decrementFetches({options, url}), wrappedNext(null, response)])\n      .catch((error) =>\n        createErrorResponse(error)\n          .then((response) => {\n            const actions = [decrementFetches({options, url}), wrappedNext(error, response)]\n            if (dispatchFetchError) actions.push(fetchError(response))\n            return actions\n          }))\n  ]\n}\n\n/**\n * @returns Promise\n */\nexport function runFetchMultiple ({\n  fetches,\n  next\n}, state) {\n  const dispatchFetchError = !next || next.length < 2\n  const wrappedNext = wrapNext(next)\n\n  return [\n    ...fetches.map(({options, url}) => incrementFetches({options, url})),\n    Promise.all(fetches.map((fetch) => runFetch(fetch, state)))\n      .then((responses) => [\n        ...fetches.map(({options, url}) => decrementFetches({options, url})),\n        wrappedNext(null, responses)\n      ])\n      .catch((error) =>\n        createErrorResponse(error)\n          .then((response) => {\n            const actions = fetches.map(({options, url}) => decrementFetches({options, url}))\n            if (dispatchFetchError) actions.push(fetchError(response))\n            return [...actions, wrappedNext(error, response)]\n          }))\n  ]\n}\n\nfunction createAuthorizationHeader (state) {\n  return state.user && state.user.idToken\n    ? {Authorization: `bearer ${state.user.idToken}`}\n    : {}\n}\n\nfunction checkStatus (res) {\n  if (res.status >= 200 && res.status < 300) {\n    return res\n  } else {\n    throw res\n  }\n}\n\nfunction createContentHeader (body) {\n  if (body instanceof window.FormData) {\n    return {}\n  } else if (isObject(body)) {\n    return {'Accept': 'application/json', 'Content-Type': 'application/json;charset=UTF-8'}\n  } else {\n    return {}\n  }\n}\n\nfunction createErrorResponse (res) {\n  return res.headers\n    ? createResponse(res)\n    : Promise.resolve(res)\n}\n\nfunction createResponse (res) {\n  return deserialize(res)\n    .then((value) => ({\n      url: res.url,\n      status: res.status,\n      statusText: res.statusText,\n      headers: res.headers,\n      value\n    }))\n    .catch((err) => ({\n      value: err\n    }))\n}\n\nfunction deserialize (res) {\n  const header = `${res.headers.get('Content-Type')} ${res.headers.get('Content')}`\n  if (header.indexOf('application/json') > -1) return res.json()\n  if (header.indexOf('application/ld+json') > -1) return res.json()\n  if (header.indexOf('application/octet-stream') > -1) return res.arrayBuffer()\n  return res.text()\n}\n\nfunction serialize (body) {\n  if (body instanceof window.FormData) {\n    return body\n  } else if (isObject(body)) {\n    return JSON.stringify(body)\n  } else {\n    return body\n  }\n}\n\nfunction wrapNext (next) {\n  return function (error, response) {\n    if (next) {\n      if (next.length > 1) {\n        return next(error, response)\n      } else if (!error) {\n        return next(response)\n      }\n    }\n  }\n}\n"]}